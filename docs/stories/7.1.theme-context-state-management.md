# Story 7.1: Theme Context & State Management

## Status
Approved

## Story
**As a** Developer,
**I want** a robust theme management system with React Context,
**so that** I can efficiently switch between Ocean, Sunset, and Forest themes across the entire application with proper state persistence.

## Acceptance Criteria
1. A ThemeContext provider is created that manages theme state (Ocean, Sunset, Forest) and light/dark mode preferences.
2. Theme state is persisted in localStorage to maintain user preferences across browser sessions.
3. A custom useTheme hook is implemented to provide easy access to theme state and switching functions.
4. Theme switching logic properly handles CSS variable updates without requiring page reloads.
5. Initial theme state is properly hydrated from localStorage on application startup.
6. Theme context provides type-safe theme options and switching methods.
7. Default theme fallback behavior is implemented when no stored preference exists.

## Tasks / Subtasks
- [x] Create ThemeContext and Provider component (AC: 1)
  - [x] Define ThemeContext interface with theme state, mode state, and switching functions
  - [x] Implement ThemeProvider component with useState for theme and mode management
  - [x] Add TypeScript types for theme IDs ('ocean', 'sunset', 'forest') and modes ('light', 'dark')
- [x] Implement localStorage persistence (AC: 2, 5, 7)
  - [x] Create utility functions for saving/loading theme preferences from localStorage
  - [x] Add initial hydration logic that runs on component mount
  - [x] Implement fallback to default theme (Ocean) when no stored preference exists
  - [x] Handle SSR compatibility with proper client-side hydration
- [x] Create useTheme custom hook (AC: 3, 6)
  - [x] Implement hook that returns current theme, mode, and switching functions
  - [x] Add TypeScript types for hook return values
  - [x] Include error handling for when hook is used outside provider context
- [x] Implement CSS variable switching logic (AC: 4)
  - [x] Create function to dynamically apply theme CSS classes to document root
  - [x] Ensure smooth transitions between themes without page reloads
  - [x] Handle both theme switching and light/dark mode switching
- [x] Add unit tests for theme system (Testing Requirements)
  - [x] Test ThemeContext provider state management
  - [x] Test useTheme hook functionality
  - [x] Test localStorage persistence and hydration
  - [x] Test CSS variable updates and theme switching

## Dev Notes

### Previous Story Insights
[Source: docs/stories/6.2.final-polish-performance-optimization.md#dev-agent-record]
Previous story completed comprehensive performance optimization and accessibility improvements. All 406 tests pass successfully, ESLint validation is clean, and production build is optimized. The theme system should maintain this performance standard and testing coverage.

### Tech Stack Requirements
[Source: docs/architecture/3-tech-stack.md]
**MUST use these exact versions:**
- **Framework**: Next.js ~14.2.3 (App Router with static export)
- **UI Library**: React ~18.3.1 (Component architecture with Context API)
- **Styling**: Tailwind CSS ~3.4.3 (Utility-first CSS with design system)
- **Language**: TypeScript ~5.4.5 (Type safety throughout)
- **Testing**: Jest / RTL ~29.7.0 (Unit and integration testing)

### Project Structure Requirements
[Source: docs/architecture/5-unified-project-structure.md]
**File locations for this story:**
- `/src/lib/theme-context.tsx` - ThemeContext, ThemeProvider, and useTheme hook
- `/src/lib/theme-utils.ts` - Utility functions for localStorage and CSS variable management
- `/src/lib/theme-context.test.tsx` - Unit tests for theme context functionality
- `/src/lib/theme-utils.test.ts` - Unit tests for utility functions

**Architecture compliance:**
- Maintain Next.js App Router patterns with proper Context provider placement
- Use TypeScript for all theme-related interfaces and type definitions
- Follow existing project structure with utilities in `/src/lib/`
- Ensure static export compatibility for Vercel deployment

### Theme Configuration Requirements
[Source: src/styles/themes/index.ts]
**Available themes:**
- **Ocean**: Deep blue ocean tones (hsl(200 100% 25%))
- **Sunset**: Warm orange/red theme (hsl(15 85% 50%))
- **Forest**: Green-based natural theme (hsl(150 80% 25%))

**Theme CSS files already exist:**
- `src/styles/themes/ocean.css` - Complete light & dark mode variables
- `src/styles/themes/sunset.css` - Complete light & dark mode variables  
- `src/styles/themes/forest.css` - Complete light & dark mode variables

**CSS Structure:**
- Uses HSL space-separated values format (e.g., "200 100% 25%")
- Compatible with Tailwind CSS and shadcn/ui components
- Each theme includes comprehensive color palettes for both light and dark mode variants

### State Management Requirements
**Context Pattern:**
- Use React.createContext for theme state management
- Implement provider pattern with state and dispatch functions
- Ensure type safety with TypeScript interfaces

**localStorage Integration:**
- Key: 'aha-agile-theme-preferences'
- Store both theme ID and mode preference
- Handle JSON serialization/deserialization
- Implement error handling for localStorage access failures

**SSR Compatibility:**
- Use useEffect for client-side hydration to avoid hydration mismatches
- Provide sensible defaults for server-side rendering
- Implement proper loading states during hydration

### CSS Variable Management
**Dynamic Theme Application:**
- Apply theme classes to document.documentElement
- Remove previous theme classes before applying new ones
- Ensure CSS cascade properly updates all components
- Maintain smooth visual transitions during theme switches

### Testing
[Source: docs/architecture/8-testing-strategy.md]
**Testing Standards:**
- **Unit Tests**: Located alongside component files using Jest and React Testing Library
- **Test Coverage**: Context provider, custom hooks, and utility functions
- **Integration Tests**: Full theme switching workflow with localStorage persistence

**Required Test Cases:**
- ThemeProvider state management and context value provision
- useTheme hook return values and functions
- localStorage save/load functionality with error handling
- CSS class application and removal
- SSR hydration behavior
- Default fallback behavior when no stored preferences exist

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-31 | 1.0 | Initial story creation for Epic 7.1 | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Implementation completed successfully on feature/story-7.1-theme-context branch
- All unit tests passing (39 tests total)
- TypeScript compilation successful
- No ESLint errors

### Completion Notes
- Created comprehensive ThemeContext with full TypeScript support
- Implemented localStorage persistence with error handling and SSR compatibility
- Built robust useTheme hook with proper error boundaries
- Added CSS class management for dynamic theme switching
- Created comprehensive test suites with 100% coverage of core functionality
- All acceptance criteria met and validated through unit tests

### File List
- src/lib/theme-context.tsx - Main ThemeContext provider and useTheme hook
- src/lib/theme-utils.ts - Utility functions for localStorage and CSS management
- src/lib/theme-context.test.tsx - Comprehensive unit tests for theme context
- src/lib/theme-utils.test.ts - Unit tests for utility functions

### Change Log
| Date | Description | Files Modified |
|------|-------------|----------------|
| 2025-07-31 | Initial theme context implementation | src/lib/theme-context.tsx |
| 2025-07-31 | Theme utilities implementation | src/lib/theme-utils.ts |
| 2025-07-31 | Comprehensive test suite creation | src/lib/theme-context.test.tsx, src/lib/theme-utils.test.ts |
| 2025-07-31 | Story tasks completed and marked done | docs/stories/7.1.theme-context-state-management.md |

### Status
Ready for Review

## QA Results
*This section will be populated during QA review*